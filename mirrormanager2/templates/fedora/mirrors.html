{% extends "master.html" %}

{% from "_macros.html" import pagination_bar %}

{% block title %}Mirrors{% endblock %}
{%block tag %}mirrors{% endblock %}

{% block content %}
<h2>Public active mirrors</h2>

{% if mirrors %}
<p>
  We currently have {{ mirrors | length }} active mirror{% if mirrors | length != 1 %}s{% endif %}
  {%- if filters["product"] %} for {{filters["product"]}} {%- endif -%}
  {%- if filters["version"] %} {{filters["version"]}} {%- endif -%}
  {%- if filters["arch"] %} on {{filters["arch"]}} {%- endif -%}
  {%- if filters["country"] %} in {{filters["country"]}} {%- endif -%}
  .
</p>

<table class="table table-striped">
  <tr>
    <th>
      <select class="form-select form-select-sm d-inline fw-bold w-auto ms-1" id="country-filter" name="country">
        <option value="">Country</option>
        {% for country in countries %}
          <option value="{{ country.code }}" {% if selected_country == country.code %}selected{% endif %}>
            {{ country.code }}
          </option>
        {% endfor %}
      </select>
    </th>
    <th>Site Name</th>
    <th>Mirror Name</th>
    <th>Categories</th>
    <th>Bandwith</th>
    <th>Internet2</th>
    <th>Comment</th>
  </tr>
  {% for mirror in mirrors.items %}
  <tr class="mirror-row">
    <td>{{ mirror.country }}</td>
    <td>
      <a href="{{ mirror.site.org_url }}">
        {{ mirror.site.name }}
      </a>
    </td>
    <td>{{ mirror.name }}</td>
    <td>
      <ul class="list-unstyled">
      {% for cat in mirror.categories %}
        {% if cat.urls %}
          <li>
          {{ cat.category.name }}
          {% for url in cat.urls %}
            <a href="{{ url.url }}">{{ url.url.split('://')[0] }}</a>
          {% endfor %}
          </li>
        {% endif %}
      {% endfor %}
      </ul>
    </td>
    <td>{{ mirror.bandwidth_int }}</td>
    <td>{% if mirror.internet2 %}Yes{% else %}No{% endif %}</td>
    <td>{% if mirror.comment %}{{ mirror.comment }}{% endif %}</td>
  </tr>
  {% endfor %}
</table>

{{pagination_bar(mirrors)}}
{% else %}
<p>
  There are currently no active mirrors registered.
</p>
{% endif %}

{% endblock %}

{% block jscripts %}
{{bottomincludes()}}
<script>
document.getElementById('country-filter').addEventListener('change', function() {
    const selectedCountry = this.value;
    const currentUrl = new URL(window.location);

    if (selectedCountry) {
        currentUrl.searchParams.set('country', selectedCountry);
    } else {
        currentUrl.searchParams.delete('country');
    }

    window.location.href = currentUrl.toString();
});
</script>
{% endblock %}
